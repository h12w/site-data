<!DOCTYPE html>
<html lang="en">
    <head>
	<meta name="generator" content="Hugo 0.53" />
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title> Hai-Liang &#34;Hal&#34; Wang </title>
        <link rel="shortcut icon" href="/img/favicon.png" />

        <style>
            html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;font-size:100%;vertical-align:baseline}html{line-height:1}ol,ul{list-style:none}table{border-collapse:collapse;border-spacing:0}caption,th,td{text-align:left;font-weight:normal;vertical-align:middle}q,blockquote{quotes:none}q:before,q:after,blockquote:before,blockquote:after{content:"";content:none}a img{border:none}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}@font-face{font-family:'Alegreya';font-style:normal;font-weight:400;src:url("/font/Alegreya400normal.ttf") format("truetype"),url("/font/Alegreya400normal.woff") format("woff"),url("/font/Alegreya400normal.eot") format("embedded-opentype")}@font-face{font-family:'Alegreya';font-style:italic;font-weight:400;src:url("/font/Alegreya400italic.ttf") format("truetype"),url("/font/Alegreya400italic.woff") format("woff"),url("/font/Alegreya400italic.eot") format("embedded-opentype")}@font-face{font-family:'Alegreya';font-style:normal;font-weight:700;src:url("/font/Alegreya700normal.ttf") format("truetype"),url("/font/Alegreya700normal.woff") format("woff"),url("/font/Alegreya700normal.eot") format("embedded-opentype")}@font-face{font-family:'Open Sans Condensed';font-style:normal;font-weight:300;src:url("/font/OpenSansCondensed300normal.ttf") format("truetype"),url("/font/OpenSansCondensed300normal.woff") format("woff"),url("/font/OpenSansCondensed300normal.eot") format("embedded-opentype")}@font-face{font-family:'Open Sans Condensed';font-style:italic;font-weight:300;src:url("/font/OpenSansCondensed300italic.ttf") format("truetype"),url("/font/OpenSansCondensed300italic.woff") format("woff"),url("/font/OpenSansCondensed300italic.eot") format("embedded-opentype")}html{font-size:118.75%;line-height:1.57895em}*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}html{font-family:Alegreya,sans-serif;background:#262626;color:#d9d9d9;-webkit-transform:translate3d(0, 0, 0)}.container{max-width:37.5rem;margin-left:auto;margin-right:auto}.container:after{content:" ";display:block;clear:both}h1,h2,h3,h4,h5,h6{font-family:"Open Sans Condensed",sans}a{text-decoration:none}a{color:#75A6C4}a:hover{color:#a9c8da;text-decoration:none}em{font-style:italic}strong{color:#fff}code{font-family:Menlo,Consolas,"Ubuntu Mono",monospace,sans;background-color:#1a1a1a;-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;font-size:.89474rem;line-height:1.57895rem;white-space:pre}p code,li code{padding:0.15rem}pre code{word-wrap:break-word;white-space:pre-wrap;padding-left:0.5rem;padding-right:0.5rem;display:block}code.mathjax{-webkit-font-smoothing:antialiased;background:inherit !important;border:none !important;font-size:100%}table{font-family:Menlo,Consolas,"Ubuntu Mono",monospace,sans;border:1px solid #8c8c8c;margin-left:auto;margin-right:auto}thead,tfoot{border:1px solid #8c8c8c}th,td{padding:0.1rem 0.5rem;text-align:center;background-color:#1a1a1a}#logo{float:left;padding-left:.78947rem;line-height:2.36842rem;height:2.36842rem}@font-face{font-family:'icon';src:url("../font/icon.eot?15086725");src:url("../font/icon.eot?15086725#iefix") format("embedded-opentype"),url("../font/icon.woff2?15086725") format("woff2"),url("../font/icon.woff?15086725") format("woff"),url("../font/icon.ttf?15086725") format("truetype"),url("../font/icon.svg?15086725#icon") format("svg");font-weight:normal;font-style:normal}[class^="icon-"]:before,[class*=" icon-"]:before{font-family:"icon";font-style:normal;font-weight:normal;speak:none;display:inline-block;text-decoration:inherit;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-article:before{content:'󰀀'}.icon-project:before{content:'󰀁'}.icon-note:before{content:'󰀂'}.icon-slide:before{content:'󰀃'}.icon-about:before{content:'󰀄'}.icon-menu:before{content:'󰀅'}nav{padding-left:.78947rem;padding-right:.78947rem;padding-top:0;padding-bottom:0}#nav-toggle-check{display:none}#nav-toggle-check:checked ~ #nav-toggle-button{color:#fefefe}#nav-toggle-check:checked ~ #nav-content{-moz-transition:all 300ms;-o-transition:all 300ms;-webkit-transition:all 300ms;transition:all 300ms;max-height:12.63158rem}#nav-toggle-button{float:right;font-size:25px;line-height:2.36842rem;height:2.36842rem}@media (min-width: 45em){#nav-toggle-button{display:none}}#nav-toggle-button:hover{color:#fefefe;cursor:pointer}#nav-content{clear:both;max-height:0}@media (min-width: 30em) and (max-width: 45em){#nav-content{text-align:center}}@media (min-width: 45em){#nav-content{clear:none;float:right;-moz-transition:all 300ms;-o-transition:all 300ms;-webkit-transition:all 300ms;transition:all 300ms;max-height:12.63158rem}}#nav-links{display:inline}@media (min-width: 30em){#nav-links{line-height:2.36842rem}}#nav-links h2{display:block;margin-top:0;margin-left:0;margin-right:0}@media (min-width: 30em){#nav-links h2{display:inline;margin-top:0;margin-bottom:0;margin-left:0.5rem;margin-right:0.5rem}}.nav-search-form{padding-bottom:.78947rem;position:relative;top:0}@media (min-width: 30em) and (max-width: 45em){.nav-search-form{margin-left:auto;margin-right:auto}}@media (min-width: 45em){.nav-search-form{display:inline-block;margin-left:0.5rem;padding-bottom:0;top:-0.1rem}}.nav-search-box{min-width:128px;height:1.2rem;background-color:#404040;color:#d9d9d9;font-size:15px;padding:0.2rem 0.4rem;border:1px solid #d9d9d9;outline:0px none;border-radius:3px;background-image:url("/img/cse.png");background-size:119px 16px;background-repeat:no-repeat;background-position:left 0.2rem center}@media (min-width: 45em){.nav-search-box{width:128px}}.nav-search-box:hover,.nav-search-box:focus,.nav-search-box:valid{border-color:#fefefe;background-image:none;box-shadow:0px 1px 1px rgba(0,0,0,0.075) inset,0px 0px 8px #fefefe}#top-header{overflow:hidden;*zoom:1;position:fixed;top:0;z-index:9999;width:100%;background:#404040}#top-header h1{font-size:25px}#top-header h2{font-size:19px;font-family:"Open Sans Condensed",sans}#top-header h1 strong{color:#FF7F00;font-family:Alegreya,sans-serif}#top-header a{color:#d9d9d9}#top-header a:hover{color:#fefefe}main{padding-top:3.15789rem;max-width:37.5rem;margin-left:auto;margin-right:auto;padding-left:.78947rem;padding-right:.78947rem}main:after{content:" ";display:block;clear:both}article ul{list-style:disc outside}article ol{list-style-type:decimal}article ul,article ol{margin-left:2.76316rem;margin-right:2.76316rem}article pre{margin-left:1.57895rem;margin-right:1.57895rem}article p{margin-top:1.57895rem}article .time{display:block;font-size:1rem;line-height:1.57895rem;font-family:"Open Sans Condensed",sans;color:#999}article h1{margin-top:1.57895rem;font-size:2.05263rem;line-height:3.15789rem}article h2{margin-top:1.57895rem;font-size:1.57895rem;line-height:1.57895rem;margin-bottom:1.57895rem}article h3{margin-top:1.57895rem;font-size:1.21053rem;line-height:1.57895rem;margin-bottom:1.57895rem}article h4{font-size:1.05263rem;line-height:1.57895rem}article h5{font-size:1.05263rem;line-height:1.57895rem}article h6{font-size:1.05263rem;line-height:1.57895rem}.hyphenate p,.hyphenate ul,.hyphenate ol{-moz-hyphens:auto;-ms-hyphens:auto;-webkit-hyphens:auto;hyphens:auto}body.css-hyphens .hyphenate p,body.css-hyphens .hyphenate ul,body.css-hyphens .hyphenate ol{text-align:justify}article.single h1{color:#fff;text-align:center;margin-bottom:1.57895rem}article.frontpage .article-body{margin-left:1.57895rem;margin-right:1.57895rem}article.frontpage h1{position:relative}article.frontpage h1 span.line{position:absolute;display:block;width:100%;margin:0;border:0;border-top:0.056rem solid rgba(38,38,38,0.5);border-bottom:0.056rem solid rgba(217,217,217,0.2)}article.frontpage .time{margin-bottom:1.57895rem}article.list h2{margin-top:1.57895rem;font-size:1.31579rem;line-height:1.57895rem;margin-bottom:0rem}h1.list{margin-top:1.57895rem;font-size:1.73684rem;line-height:1.57895rem;margin-bottom:1.57895rem}p#more{font-family:"Open Sans Condensed",sans;font-size:1.31579rem;line-height:1.57895rem;font-style:italic;margin-top:1.57895rem}#site-footer{margin-top:1.57895rem;margin-bottom:.3125rem;text-align:center;font-size:.89474rem;line-height:1.57895rem}#site-footer hr{border:0;height:1px;background-image:url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuMCIgeTE9IjAuNSIgeDI9IjEuMCIgeTI9IjAuNSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzI2MjYyNiIvPjxzdG9wIG9mZnNldD0iNTAlIiBzdG9wLWNvbG9yPSIjZDlkOWQ5IiBzdG9wLW9wYWNpdHk9IjAuMzgyIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMjYyNjI2Ii8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmFkKSIgLz48L3N2Zz4g');background-size:100%;background-image:-webkit-gradient(linear, 0% 50%, 100% 50%, color-stop(0%, #262626),color-stop(50%, rgba(217,217,217,0.382)),color-stop(100%, #262626));background-image:-moz-linear-gradient(left, #262626,rgba(217,217,217,0.382),#262626);background-image:-webkit-linear-gradient(left, #262626,rgba(217,217,217,0.382),#262626);background-image:linear-gradient(to right, #262626,rgba(217,217,217,0.382),#262626)}div.gsc-adBlock,#discovery-top{display:none !important}.cse .gsc-control-cse,.gsc-control-cse{background-color:#262626 !important;border:none !important}.gs-result .gs-title,.gs-result .gs-title *{color:#75A6C4 !important;text-decoration:none !important}.gs-result .gs-title:hover,.gs-result .gs-title *:hover{text-decoration:underline !important}.gsc-preview-reviews,.gsc-control-cse .gs-snippet,.gsc-control-cse .gs-promotion em,.gsc-control-cse .gs-snippet,.gsc-control-cse .gs-promotion em,.gsc-result-info,.gsc-orderby-label{color:#d9d9d9 !important}.gsc-webResult.gsc-result{border:none !important}.gsc-above-wrapper-area{border-bottom:none !important}.gsc-control-cse,.gsc-control-cse *{box-sizing:content-box}.gsc-result .gs-title{height:auto !important}.gsc-selected-option-container{background-color:#262626 !important;background-image:url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjAuMCIgeDI9IjAuNSIgeTI9IjEuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzI2MjYyNiIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzQwNDA0MCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==') !important;background-size:100%;background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #262626),color-stop(100%, #404040)) !important;background-image:-moz-linear-gradient(top, #262626,#404040) !important;background-image:-webkit-linear-gradient(top, #262626,#404040) !important;background-image:linear-gradient(to bottom, #262626,#404040) !important}.gsc-selected-option-container{color:#d9d9d9 !important}.gsc-control-cse .gsc-option-menu{background:#262626 !important;border:1px solid rgba(38,38,38,0.2);box-shadow:0 2px 4px #262626}.gsc-option-menu-item{color:#d9d9d9 !important}.gsc-option-menu-item-highlighted{background-color:#404040 !important;border-color:#d9d9d9 !important;color:#d9d9d9 !important}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{color:#75A6C4 !important;cursor:pointer !important;background-color:#262626 !important}.gs-result a.gs-visibleUrl,.gs-result .gs-visibleUrl{color:forestgreen !important}.gsc-result-info{padding-top:.78947rem !important;padding-bottom:.78947rem !important}.cse .gsc-control-cse,.gsc-control-cse,.gsc-above-wrapper-area,.gcsc-branding,.gsc-results,.gs-result a.gs-visibleUrl,.gs-result .gs-visibleUrl,.gsc-table-result,.gsc-thumbnail-inside,.gsc-url-top{padding:0 !important}td.gcsc-branding-text div.gcsc-branding-text{margin:0 !important;padding:0 !important}img.gsc-branding-img,img.gsc-branding-img-noclear,img.gcsc-branding-img,img.gcsc-branding-img-noclear{vertical-align:middle !important}.gsc-webResult .gsc-result{background-color:#262626 !important;padding-top:1.57895rem !important;padding-bottom:0 !important}.gsc-results .gsc-cursor-box{margin-top:1.57895rem !important;margin-bottom:1.57895rem !important}.hljs,.hljs-tag,.css .hljs-rules,.css .hljs-value,.css .hljs-function .hljs-preprocessor,.hljs-pragma{color:#d9d9d9}.hljs-strongemphasis,.hljs-strong,.hljs-emphasis{color:#a8a8a2}.hljs-bullet,.hljs-blockquote,.hljs-horizontal_rule,.hljs-number,.hljs-regexp,.alias .hljs-keyword,.hljs-literal,.hljs-hexcolor{color:#ae81ff}.hljs-tag .hljs-value,.hljs-code,.hljs-title,.css .hljs-class,.hljs-class .hljs-title:last-child{color:#a6e22e}.hljs-link_url{font-size:80%}.hljs-strong,.hljs-strongemphasis{font-weight:bold}.hljs-emphasis,.hljs-strongemphasis,.hljs-class .hljs-title:last-child{font-style:italic}.hljs-keyword,.hljs-function,.hljs-change,.hljs-winutils,.hljs-flow,.lisp .hljs-title,.clojure .hljs-built_in,.nginx .hljs-title,.tex .hljs-special,.hljs-header,.hljs-attribute,.hljs-symbol,.hljs-symbol .hljs-string,.hljs-tag .hljs-title,.hljs-value,.alias .hljs-keyword:first-child,.css .hljs-tag,.css .unit,.css .hljs-important{color:#D12060}.hljs-function .hljs-keyword,.hljs-class .hljs-keyword:first-child,.hljs-constant,.css .hljs-attribute{color:#66d9ef}.hljs-variable,.hljs-params,.hljs-class .hljs-title{color:#f8f8f2}.hljs-string,.css .hljs-id,.hljs-subst,.haskell .hljs-type,.ruby .hljs-class .hljs-parent,.hljs-built_in,.django .hljs-template_tag,.django .hljs-variable,.smalltalk .hljs-class,.django .hljs-filter .hljs-argument,.smalltalk .hljs-localvars,.smalltalk .hljs-array,.hljs-attr_selector,.hljs-pseudo,.hljs-addition,.hljs-stream,.hljs-envvar,.apache .hljs-tag,.apache .hljs-cbracket,.tex .hljs-command,.hljs-prompt,.hljs-link_label,.hljs-link_url{color:#e6db74}.hljs-comment,.hljs-javadoc,.java .hljs-annotation,.python .hljs-decorator,.hljs-template_comment,.hljs-pi,.hljs-doctype,.hljs-deletion,.hljs-shebang,.apache .hljs-sqbracket,.tex .hljs-formula{color:#75715e}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata,.xml .php,.php .xml{opacity:0.5}ul#tags{font-family:"Open Sans Condensed",sans;clear:both;list-style:none;line-height:3.15789rem;padding:0}@media (min-width: 45em){ul#tags{clear:none}}ul#tags li{float:left;line-height:1.26316rem;margin-top:.94737rem;margin-left:0.4rem}@media (min-width: 45em){ul#tags li{float:right}}ul#tags li a{font-size:17px;color:#000;background:#75A6C4;border-radius:3px;padding-left:0.2rem;padding-right:0.2rem;padding-bottom:0.1rem;cursor:pointer}ul#tags li a:hover{background:#a9c8da;outline:none}#article-time{float:left;font-family:"Open Sans Condensed",sans;font-size:1.31579rem;line-height:3.15789rem;color:#999}#livefyre-comments{padding-top:3.15789rem;font-family:"Open Sans Condensed",sans}#livefyre-comments p{font-family:Alegreya,sans-serif}#livefyre-comments .fyre .fyre-help{display:none}#livefyre-comments .fyre .fyre-login-bar{font-family:inherit}#livefyre-comments .fyre .fyre-comment-article,#livefyre-comments .fyre .fyre-comment-stream{font-family:inherit;font-size:1rem;line-height:1.57895rem;margin:0}#livefyre-comments .fyre .fyre-comment{margin:0}#livefyre-comments .fyre .fyre-comment p{margin-bottom:1.57895rem;line-height:1.57895rem}#livefyre-comments .fyre .fyre-comment p:last-child{margin-bottom:0}#livefyre-comments .fyre .fyre-comment a.fyre-comment-edit{font-size:17px}#livefyre-comments .fyre .fyre-comment-footer{margin:0;padding:0;line-height:1.57895rem;height:1.57895rem;font-family:"Open Sans Condensed",sans}#livefyre-comments .fyre .fyre-comment-actions{margin-top:0;font-size:17px}#livefyre-comments .fyre .fyre-comment-actions a:hover{text-decoration:none}#livefyre-comments .fyre .fyre-comment-like,#livefyre-comments .fyre .fyre-comment-reply,#livefyre-comments .fyre .fyre-comment-like-count,#livefyre-comments .fyre .fyre-comment-like-btn{font-size:17px}#livefyre-comments .fyre .fyre-stream-stats span{line-height:1.57895rem}#livefyre-comments .fyre .fyre-stream-stats .fyre-comment-count{font-family:inherit;font-weight:normal;font-size:1.31579rem;line-height:1.57895rem}#livefyre-comments .fyre .fyre-livecount{top:auto;position:static}#livefyre-comments .fyre .fyre-auth{margin-top:1.57895rem}#livefyre-comments .fyre .fyre-stream-stats,#livefyre-comments .fyre .fyre-box-wrapper a.fyre-user-profile-link,#livefyre-comments .fyre .fyre-stream-livecount,#livefyre-comments .fyre .fyre-comment-stream,#livefyre-comments .fyre .fyre-comment-actions{color:#d9d9d9}#livefyre-comments .fyre .fyre-box-wrapper:hover{background:none}#livefyre-comments .fyre .fyre-box-list{background:none repeat scroll 0% 0% #262626;color:#d9d9d9}#livefyre-comments .fyre .fyre-box-list li a{color:#d9d9d9}#livefyre-comments .fyre .fyre-box-list li a:hover{color:#262626;background-color:#d9d9d9}#livefyre-comments .fyre .fyre-user-loggedout{color:#d9d9d9}#livefyre-comments .fyre .fyre-user-loggedout,#livefyre-comments .fyre .fyre-stream-sort,#livefyre-comments .fyre .fyre-stream-stats,#livefyre-comments .fyre .fyre-stream-livecount{font-family:inherit;font-size:17px;line-height:1.57895rem}#livefyre-comments .fyre .fyre-moderator{display:none}#livefyre-comments .fyre a{color:#75A6C4}#livefyre-comments .fyre a:hover{color:#a9c8da}#livefyre-comments .fyre .fyre-stream-sort{border:none;margin:0;padding-top:.78947rem;padding-bottom:.78947rem;line-height:1.57895rem}#livefyre-comments .fyre .fyre-comment-article{margin-top:1.57895rem}#livefyre-comments .fyre .fyre-comment-head{position:relative}#livefyre-comments .fyre .fyre-comment-head .fyre-comment-username::before{content:"";position:absolute;width:100%;height:0px;background:none;border:0;border-top:0.056rem solid rgba(38,38,38,0.5);border-bottom:0.056rem solid rgba(217,217,217,0.2)}#livefyre-comments .fyre .fyre-comment-divider{display:none}#livefyre-comments .fyre .fyre-comment-wrapper time.fyre-comment-date{font-size:17px}#livefyre-comments .fyre-editor{margin:0;padding-top:2.36842rem}#livefyre-comments .fyre-editor .fyre-editor-container .fyre-editor-editable{color:#d9d9d9;background-color:transparent;font-family:inherit;font-size:1rem;line-height:1.57895rem;overflow:hidden;padding:.78947rem}#livefyre-comments .fyre-editor .fyre-editor-container .fyre-editor-editable p{line-height:1.5}#livefyre-comments .fyre-editor .fyre-editor-toolbar{height:60px}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div{color:#d9d9d9;background-image:url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjAuMCIgeDI9IjAuNSIgeTI9IjEuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzI2MjYyNiIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzNiM2IzYiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==');background-size:100%;background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #262626),color-stop(100%, #3b3b3b));background-image:-moz-linear-gradient(top, #262626,#3b3b3b);background-image:-webkit-linear-gradient(top, #262626,#3b3b3b);background-image:linear-gradient(to bottom, #262626,#3b3b3b)}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div.fyre-format-button{display:none}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div.fyre-mention-button{border-bottom:1px solid #a1a1a1;border-left:1px solid #a1a1a1;-moz-border-radius:0 0 0 5px;-webkit-border-radius:0;border-radius:0 0 0 5px}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div.fyre-mention-button>div{background:url("/img/sprites.png") no-repeat scroll 9px -57px transparent}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div.fyre-embed-button>div{background:url("/img/sprites.png") no-repeat scroll 8px -121px transparent}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div.fyre-button-left .fyre-button-left-outer-box .fyre-button-left-inner-box{text-shadow:none}#livefyre-comments .fyre-editor .fyre-editor-toolbar .goog-toolbar>div.fyre-button-right.fyre-post-button .fyre-button-right-outer-box .fyre-button-right-inner-box{color:#d9d9d9;text-shadow:none}#livefyre-comments .fyre-editor .fyre-editor-toolbar .fyre-share-container{background-color:#262626}#livefyre-comments .fyre-editor .fyre-editor-toolbar .fyre-share-container span>a{color:#d9d9d9}#livefyre-comments .fyre-editor .fyre-editor-toolbar .fyre-share-container span>a:hover{color:#262626;background-color:#d9d9d9}#livefyre-comments .fyre-editor .fyre-editor-toolbar .fyre-format-toolbar{background-color:#262626}#livefyre-comments .fyre-editor .fyre-editor-toolbar .fyre-mention-menu{background-color:#262626}#livefyre-comments .fyre-editor .fyre-editor-toolbar .fyre-mention-menu .fyre-mention-item{height:auto}.my-name{font-family:Constantia,"Lucida Bright",Lucidabright,"Lucida Serif",Lucida,"DejaVu Serif","Bitstream Vera Serif","Liberation Serif",Georgia,serif;font-size:90%}#github-ribbon{position:fixed;width:200px;top:2.36842rem;margin-top:34px;right:-50px;-moz-transform:rotate(45deg);-ms-transform:rotate(45deg);-webkit-transform:rotate(45deg);transform:rotate(45deg);background-color:#FF7F00;background-image:url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjAuMCIgeDI9IjAuNSIgeTI9IjEuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzAwMDAwMCIgc3RvcC1vcGFjaXR5PSIwLjAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMDAwMDAiIHN0b3Atb3BhY2l0eT0iMC4xNSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==');background-size:100%;background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, rgba(0,0,0,0)),color-stop(100%, rgba(0,0,0,0.15)));background-image:-moz-linear-gradient(top, rgba(0,0,0,0),rgba(0,0,0,0.15));background-image:-webkit-linear-gradient(top, rgba(0,0,0,0),rgba(0,0,0,0.15));background-image:linear-gradient(to bottom, rgba(0,0,0,0),rgba(0,0,0,0.15));font-family:HelveticaNeue,"Helvetica Neue",HelveticaNeueRoman,HelveticaNeue-Roman,"Helvetica Neue Roman",TeXGyreHerosRegular,Helvetica,Tahoma,Geneva,Arial,sans-serif;font-weight:bold;font-size:15px;padding:2px 0;z-index:10;pointer-events:auto}#github-ribbon a,#github-ribbon a:hover{color:#404040;text-decoration:none;display:inline-block;text-align:center;width:200px;border-width:1px 0;border-style:dashed;border-color:#404040}.pagination{font-family:"Open Sans Condensed",sans;font-weight:bold;margin-top:3rem;text-align:center}.pagination li{display:inline;margin-left:0.5rem;margin-right:0.5rem}.pagination .disabled{color:#999}

        </style>

        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.0/highlight.min.js"></script>
<script>
    hljs.configure({languages: []}); 
    hljs.initHighlightingOnLoad();
</script>


        <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      enableMenu: false,
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
</script>
<script src="//polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


    </head>
    <body>
        <header id="top-header">
            <div class="container">
                <h1 id="logo">
                    
                    <a rel="home" id="site-title" href="/"><strong>h12</strong></a>
                    <a href="https://stand-with-ukraine.pp.ua"><img src="https://raw.githubusercontent.com/vshymanskyy/StandWithUkraine/main/badges/StandWithUkraine.svg" alt="Stand With Ukraine"></a>
                </h1>
                <nav>
                    <input type="checkbox" id="nav-toggle-check">
                    <label id="nav-toggle-button" for="nav-toggle-check" class="icon-menu"></label>
                    <div id="nav-content">
                        <div id="nav-links">
                            <h2><a href="/article" data-nav="Article">
                                <i class="icon-article"></i><span>Article</span>
                            </a></h2>
                            <h2><a href="/project" data-nav="Project">
                                <i class="icon-project"></i><span>Project</span>
                            </a></h2>
                            <h2><a href="/note" data-nav="Note">
                                <i class="icon-note"></i><span>Note</span>
                            </a></h2>
                            
                            <h2><a href="/about" data-nav="About">
                                <i class="icon-about"></i><span>About</span>
                            </a></h2>
                        </div>
                        <form class="nav-search-form" action="/search">
                            <input type="text" class="nav-search-box" name="q" required="required"/>
                        </form>
                    </div>
                </nav>
            </div>
        </header>


        <main class="container">
        
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/article/go-pattern-hybrid-handler/">Go Pattern: Hybrid Handler</a>
                    <span class="line"></span>
                </h1>
                <span class="time">22 April 2023</span>
                <div class="article-body hyphenate">
                    

<h2 id="overview">Overview</h2>

<p>In today&rsquo;s high-performance and concurrent computing environments, effectively processing a stream of messages using a mix of purely computational functions and remote procedure calls has become a significant challenge. The Go programming language is designed to handle concurrency well, but when it comes to managing a hybrid load, even Go can struggle to achieve optimal CPU utilization. In this article, we will discuss the Hybrid Handler pattern, an efficient and unified approach to address this challenge.</p>

<h2 id="the-problem">The problem</h2>

<p>Assuming we have a stream of incoming messages and we need to process them with a list of handlers, aggregate the results and send the output downstream.</p>

<p>If all the handlers are only purely local computations, then an implementation like below already meets the basic functional and performance requirements.</p>

<pre><code class="language-go">type Processor struct {
    handlers SyncHandler
}

type SyncHandler interface {
    Handle(ctx context.Context, message Message) (Result, error)
}

func (p *Processor) ProcessMessage(ctx context.Context, message Message) error {
    output := NewOutput()
    for _, handler := range p.handlers {
        result, err := handler.Handle(ctx, message)
        if err != nil {
            return err
        }
        output.Add(result)
    }
    return p.SendOutput(output)
}
</code></pre>

<p>e.g. With an 8-core CPU, we can simply initialise 8 <code>Processor</code> objects and run them in 8 goroutines, which can make full use of the hardware easily. (error handling is omitted here)</p>

<pre><code class="language-go">for i := 0; i &lt; numCPU; i++ {
    go func() {
        processor := NewProcessor()
        for message := range inputChan {
            processor.ProcessMessage(ctx, message)
        }
    }()
}
</code></pre>

<p>However, if the processing logic involves a mix of local computations and remote procedure calls, it becomes more difficult to process a high volume of messages in a timely and efficient manner. If the processor still handles messages one by one, it must wait for all handlers to complete before outputting the corresponding result. However, The added I/O roundtrip delay for each message will be so high that the CPU cores stay idle most of the time.</p>

<p>To mitigate this issue, one could attempt to saturate the CPU with brute force, parallelizing the processors with even more goroutines, as in most microservices written in Go, where one goroutine is used to handle one incoming request. While this might work well enough for an IO-bound application or when the traffic is low, it can penalize the performance significantly when all or most of the handlers are pure computations due to the relative costs of channel message passing and goroutine scheduling compared to the computations themselves.</p>

<p>Another feasible but more ad-hoc solution is just to separate purely computational handlers from remote handlers into two groups, and execute them differently, which could potentially remove the penalty on pure computations. However, how to wait for all the results is still a problem and two separate groups add more complexity to both the start and finish of those functions.</p>

<p>What we need here is an abstraction that unifies local and remote handlers without the overhead of goroutines and channels. This would allow purely computational handlers to achieve bare metal speed while remote handlers don&rsquo;t block unnecessarily.</p>

<h2 id="the-hybrid-handler-pattern">The Hybrid Handler pattern</h2>

<pre><code class="language-go">type Handler interface {
    Handle(
        ctx          context.Context,
        message      Message,
        returnResult ReturnResultFunc,
    ) error

type ReturnResultFunc func(ctx context.Context, result Result) error
}

func (s Server) HandleMessage(ctx context.Context, message Message) error {
    for _, handler := range s.Handlers {
        handler.Handle(ctx, message, )
    }
}
</code></pre>

<p>The key to addressing these challenges lies in an interface method that provides a callback parameter <code>returnResult</code> for returning the result, which allows the implementation of the interface to be either a synchronous pure computation or an asynchronous IO operation without introducing much overhead.</p>

<p>Is it just a function with a callback?</p>

<p>Yes, at first glance, it might look not only trivial but also unidiomatic in Go, but looking closely, we will find that it is a simple and natural solution to the problem at hand and makes a lot of sense.</p>

<h2 id="the-new-processor">The new processor</h2>

<p>With the <code>Handler</code> interface above, the <code>Processor</code> can be re-implemented as below.</p>

<p>On arrival of each result, the output can decrement a counter atomically to determine if it&rsquo;s ready to be sent downstream. This operation adds much less overhead than the brute force way of adding many goroutines.</p>

<pre><code class="language-go">type Processor struct {
    handlers Handler
}

type Output struct {
    handlerCount int64
    processor *Processor
}

func (p *Processor) NewOutput(handlerCount int) *Output {
    return &amp;Output{
        HandlerCount: handlerCount,
        processor:    p,
    }
}

func (p *Processor) ProcessMessage(ctx context.Context, message Message) error {
    output := p.NewOutput(len(p.handlers))
    for _, handler := range p.handlers {
        result, err := handler.Handle(ctx, message, output.Add)
        if err != nil {
            return err
        }
    }
    return nil
}

func (o *Output) Add(ctx context.Context, result Result) error
    // add the result to the output
    // ......

    // check if it's the result of the the last handler
	if atomic.AddInt64(&amp;h.row.pendingCategories, -1) &gt; 0 {
		return nil // not the last one
	}

    // is the last one
    return p.processor.SendOutput(o)
}

</code></pre>

<h2 id="synchronous-handlers">Synchronous handlers</h2>

<p>It is almost trivial to write an adapter from any synchronous handler to the <code>Handler</code> interface above, and the overhead is just one extra interface method call.</p>

<pre><code class="language-go">type SyncHandler interface {
    Handle(ctx context.Context, message Message) (Result, error)
}

type SyncHandlerAdapter struct {
    syncHandler SyncHandler
}

func (a SyncHandlerAdapter) Handle(
    ctx          context.Context,
    message      Message,
    returnResult ReturnResultFunc,
) error {
    result, err := a.syncHandler.Handle(ctx, message)
    if err != nil {
        return err
    }
    return returnResult(ctx, result)
}
</code></pre>

<h2 id="asynchronous-handlers">Asynchronous handlers</h2>

<p>There are various techniques to wrap a remote procedure call in an asynchronous handler efficiently, e.g. a batch or a streaming API. I do not intend to cover the details here, but regardless of the implementations, the <code>Handler</code> interface allows the Handle method to return immediately without blocking the processing of the next message while a background goroutine can send the result back with the <code>returnResult</code> callback function when the result is ready later.</p>

<p>A hybrid handler is also possible, returning the result immediately for some inputs while doing it asynchronously for others.</p>

<p>We might need to pay more attention to the error handling in the asynchronous handlers. The handler must ensure a result is returned so that the output can decrement the count correctly. So one possible way is to embed the error in the result to be passed back.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In conclusion, the Hybrid Handler pattern allows synchronous and asynchronous handlers to coexist without incurring significant overhead, resulting in improved CPU utilization and reduced complexity. By implementing the Hybrid Handler pattern, developers can optimize performance in high-performance computing systems while maintaining the flexibility to handle various types of workloads.</p>

                </div>
            </article>
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/note/less-is-more-dag/">Less Is More: Directed Acyclic Graph</a>
                    <span class="line"></span>
                </h1>
                <span class="time">12 May 2022</span>
                <div class="article-body hyphenate">
                    <p>A directed acyclic graph or <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a> is a directed graph with no directed cycles.</p>

<p>An arbitrary directed graph may also be transformed into a DAG, called its <a href="https://en.wikipedia.org/wiki/Strongly_connected_component#Definitions">condensation</a>, by contracting each of its strongly connected components into a single super vertex.</p>

<p>Go&rsquo;s <a href="https://go.dev/ref/spec#Import_declarations">import declaration</a> declares a dependency relation between the importing and imported package. It is illegal for a package to import itself, directly or indirectly, or to directly import a package without referring to any of its exported identifiers.</p>

<p>&ldquo;Allowing cycles enables laziness, poor dependency management, and slow builds&rdquo; - <a href="https://github.com/golang/go/issues/30247#issuecomment-463940936">Rob Pike</a>.</p>

<p>So, definitions strongly connected to each other so much so that they form cycles should be &ldquo;condensed&rdquo; into one package, period.</p>

<p>Less is more.</p>

                </div>
            </article>
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/article/go-pattern-runner/">Go Pattern: Runner</a>
                    <span class="line"></span>
                </h1>
                <span class="time">22 February 2022</span>
                <div class="article-body hyphenate">
                    

<p>Again and again, a concurrent pattern emerges from the need to control goroutine lifecycles and handle their errors, and I call it the &ldquo;Runner Pattern&rdquo;.</p>

<h2 id="the-runner-interface-and-its-contract">The runner interface and its contract</h2>

<p>The pattern is as simple as a single-method interface:</p>

<pre><code class="language-go">// Runner defines the Run method to be executed within a goroutine
type Runner interface {
	Run(ctx context.Context) error
}
</code></pre>

<p>The contract of the interface covers two aspects.</p>

<p>On the goroutine lifecycle, the <code>Run</code> method will block until one of the following occurs:</p>

<ul>
<li>it completes successfully and returns nil</li>
<li>it fails and returns an error</li>
<li>it returns the context error as soon as the context gets cancelled</li>
</ul>

<p>On the error handling, The contract of a <code>Runner</code> also implies that:</p>

<ul>
<li>all the errors that need to be handled by the caller are returned by the <code>Run</code> method</li>
<li>the <code>Run</code> method either can be called concurrently or returns an error if it cannot</li>
<li>the <code>Run</code> method does not spawn its own goroutine directly unless there are nested <code>Runner</code>s,
whose errors need to be returned by the <code>Run</code> method too</li>
</ul>

<h2 id="a-group-of-runners">A group of runners</h2>

<p>To manage multiple runners as a group, it would be straightforward to implement a runner group as below, with some of the sync primitives like <code>WaitGroup</code> and <code>Once</code> (<a href="https://github.com/h12w/run/blob/master/simple.go">a reference implementation</a>):</p>

<pre><code class="language-go">type Group interface {
	Go(r Runner)
	Wait() error
}

func NewGroup(ctx context.Context) Group
</code></pre>

<p>With this simple group API, we could add multiple runners to a group and wait for all of them to complete. By default,
<code>Wait</code> method returns the first error that occurred in any of the runners, or nil if all runners completed successfully.</p>

<h2 id="rationale">Rationale</h2>

<p>Go&rsquo;s CSP-style concurrency model enables us writing synchronous code intuitively but under the hood, schedules them off the thread when they block and resumes them when they unblock.</p>

<p>We should make full use of the unique ability of Go, controlling lifecycles and handling errors in an intuitively synchronous way rather than fighting against CSP and writing asynchronous-style code everywhere (e.g. callbacks, future/promise, async/await etc).</p>

<p>With the runner pattern, we abstracts away the boilerplate code of goroutine spawning and error handling, so that each piece of concurrent code can focus on its own business logic.</p>

<h2 id="is-that-just-an-error-group">Is that just an error group?</h2>

<p>The <a href="https://pkg.go.dev/golang.org/x/sync/errgroup">error group</a> could be used to implement the runner pattern. In a sense,
you could even call it an error group pattern. However, the runner pattern is more about the interface contract
rather than the group implementation, and the contract is not only about error handling but also about the goroutine lifecycle.</p>

<h2 id="implementation-tips-of-a-runner">Implementation tips of a runner</h2>

<p>Here are a few tips to make a runner correct and efficient:</p>

<ul>
<li>options, input/output channels and other dependencies can all be arguments passed into the constructor function of a runner</li>
<li>a runner object should not contain any state mutable after initialisation, instead, mutable state and other resources should be scoped within the <code>Run</code> method</li>
<li>the error handling logic of returning the first error can be overridden by handling a specific type of error within the <code>Run</code> method</li>
<li>remember passing the context into wherever it is needed, and monitor if it gets cancelled, especially within loops</li>
<li>all the resources allocated within the <code>Run</code> method must be released when it returns</li>
</ul>

                </div>
            </article>
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/article/go-anti-patterns-parent-closer/">Go Anti-pattern: Parent Closer</a>
                    <span class="line"></span>
                </h1>
                <span class="time">8 January 2021</span>
                <div class="article-body hyphenate">
                    

<p>Imagine you need to wrap multiple objects which implements <code>io.Closer</code>, e.g. three clients to fetch and combine data from different endpoints.</p>

<pre><code class="language-go">type Parent struct {
    child1 Child1
    child2 Child2
    child3 Child3
}
</code></pre>

<h2 id="parent-closer">Parent closer</h2>

<p>Let&rsquo;s see how we can create and destroy a parent object.</p>

<pre><code class="language-go">func NewParent() (*Parent, error) {
    child1, err := NewChild1()
    if err != nil {
        return nil, err
    }
    child2, err := NewChild1()
    if err != nil {
        // oops, child1 needs to be closed here
        child1.Close()
        return nil, err
    }
    child3, err := NewChild1()
    if err != nil {
        // oops again, both child1, and child2 needs to be closed here
        child1.Close()
        child2.Close()
        return nil, err
    }
    return &amp;Parent{
        child1: child1,
        child2: child2,
        child3: child3,
    }, nil
}

func (p *Parent) Close() error {
    var errs []error
    if err := p.child1.Close(); err != nil {
        errs = append(errs, err)
    }
    if err := p.child2.Close(); err != nil {
        errs = append(errs, err)
    }
    if err := p.child3.Close(); err != nil {
        errs = append(errs, err)
    }
    return multierr.Combine(errs...)
}
</code></pre>

<p>Note the boilerplate code of closing the children. Because the parent creates its children, it must be responsible for calling their <code>Close</code> method whenever needed. If there are any errors during the initialisation, the children already created have to be properly closed, and before the parent exits its scope, it has to close its children too.</p>

<p>Furthermore, the <code>Closer</code> interface is contagious. If we organise our code by wrapping objects layer by layer like above, and any one of the descendants is a <code>Closer</code>, then all the types in the hierarchy are infected and have to implement the <code>Closer</code> interface too.</p>

<h2 id="parent-container">Parent container</h2>

<p>Unlike the parent closer, all of the complexity could have been avoided if the parent is a simple container, <strong>borrowing the references of the children rather than owning them</strong>, as long as the children outlive its parent.</p>

<pre><code class="language-go">
func NewParent(child1 Child1, child2 Child2, child3 Child3) *Parent {
    return &amp;Parent{child1: child1, child2: child2, child3: child3}
}

func run() error {
    child1, err := NewChild1()
    if err != nil {
        return nil, err
    }
    defer child1.Close()
    child2, err := NewChild1()
    if err != nil {
        return nil, err
    }
    defer child2.Close()
    child3, err := NewChild1()
    if err != nil {
        return nil, err
    }
    defer child3.Close()

    parent := NewParent(child1, child2, child3)

    // the parent can be used safely here before func run returns
}
</code></pre>

<p>It is usually straightforward to guarantee the children outlive its parent in real cases:</p>

<ul>
<li>either the parent is created and held by a service during its whole lifetime, and <code>func run</code> could be a function that keeps running until the service terminates</li>
<li>or the parent is created when handling a request, and <code>func run</code> is the request handler</li>
</ul>

<p>The key difference between a &ldquo;parent closer&rdquo; and a &ldquo;parent container&rdquo; is that the latter makes it possible to use the <code>defer</code> statements to close the children in either error or normal case, so the duplicated clean-up code can be avoided.</p>

<h2 id="conclusion">Conclusion</h2>

<p><code>io.Closer</code> interfaces are contagious. Usually, we do not want to wrap them to make another <code>io.Closer</code>, instead, we should only wrap them by reference borrowing, without managing their lifetime within the wrapper.</p>

                </div>
            </article>
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/article/probability-as-a-generalisation-of-boolean-algebra/">Probability as a Generalisation of Boolean Algebra</a>
                    <span class="line"></span>
                </h1>
                <span class="time">14 December 2020</span>
                <div class="article-body hyphenate">
                    

<h2 id="a-summary-of-boolean-algebra">A summary of Boolean algebra</h2>

<p>Given the following notations:</p>

<ul>
<li>a proposition is denoted as a lowercase letter, e.g. $p$, $q$</li>
<li>the truth value of a proposition $p$ is denoted as $ B(p) \in \set{0, 1} $, where $B(p)=1$ if $p$ is true or $B(p)=0$ if $p$ is false</li>
</ul>

<p>Negation (<code>not</code>, $¬$), conjunction (<code>and</code>, $∧$) and disjunction (<code>or</code>, $∨$) are defined by the truth tables below:</p>

<table>
<thead>
<tr>
<th>$B(p)$</th>
<th>$B(¬p)$</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>1</td>
</tr>

<tr>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

<p></p>

<table>
<thead>
<tr>
<th>$B(p)$</th>
<th>$B(q)$</th>
<th>$B(p∧q)$</th>
<th>$B(p∨q)$</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>

<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>

<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>

<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

<h2 id="truth-value-allocation-as-an-intuitive-picture-of-boolean-algebra">Truth value allocation as an intuitive picture of Boolean algebra</h2>

<p>Intuitively, we can derive the same truth tables by following the process of the truth value allocation with the two steps below:</p>

<ul>
<li>List all mutually exclusive results from propositions under consideration</li>
<li>Allocate the truth value to them so that their truth-values sum up to $1$</li>
</ul>

<p>Note that the second step actually requires only one of result has a truth value $1$, given $ B(p) \in \set{0, 1} $.</p>

<h3 id="negation">Negation</h3>

<p>For a single proposition $p$, there are two mutually exclusive results $p$ (is true) or $¬p$ (is true), as follows:</p>

<table>
<thead>
<tr>
<th>$¬p$</th>
<th>$p$</th>
</tr>
</thead>

<tbody>
<tr>
<td>$B(¬p)$</td>
<td>$B(p)$</td>
</tr>
</tbody>
</table>

<p>Where we can allocate the truth value:</p>

<p>$$B(¬p) + B(p) = 1$$</p>

<p>Thus we get an equivalent equation to the negation truth table.</p>

<h3 id="conjunction">Conjunction</h3>

<p>Now let&rsquo;s consider two propositions $p$ and $q$ at the same time. There are four mutually exclusive results: $(p∧q)$, $(¬p∧q)$, $(p∧¬q)$ or $(¬p∧¬q)$. Thus we have the truth value allocation table:</p>

<p></p>
<table>
<tr>
    <th></th>
    <td>$¬p$</td>
    <td>$p$</td>
</tr>
<tr>
    <th>$¬q$</th>
    <td>$B(¬p∧¬q)$</td>
    <td>$B(p∧¬q)$</td>
</tr>
<tr>
    <th>$q$</th>
    <td>$B(¬p∧q)$</td>
    <td>$B(p∧q)$</td>
</tr>
</table>
<p></p>

<p>Where we can allocate the truth value:</p>

<p>$$ B(¬p∧¬q) + B(p∧¬q) + B(¬p∧q) + B(p∧q) = 1 $$</p>

<p>From the allocation we can easily get $B(p)$ as the sum of the second column:</p>

<p>$$ B(p) = B(p∧q) + B(p∧¬q) $$</p>

<p>And $B(q)$ as the sum of the second row:</p>

<p>$$ B(q) = B(p∧q) + B(¬p∧q) $$</p>

<p>Similar equations can be derived for $B(¬p)$ as the sum of the first column and $B(¬q)$ as the sum of the first row.</p>

<p>If we use the notation $B(q|p)$ as the ratio of truth value &ldquo;q is true&rdquo; given &ldquo;p is true&rdquo;, the conjunction $B(p∧q)$ can be expressed as:</p>

<p>$$ B(p∧q) = B(p) \times B(q|p)  $$</p>

<p>This equation can be read from the allocation table as &ldquo;the sum of the first column where $p$ is true&rdquo; times &ldquo;the ratio of $q$ is true given $p$ is true&rdquo;.</p>

<p>Also, note that $B(q|p) = B(q)$, which can be easily derived from the allocation table. Thus we have the equivalent equation for the conjunction:</p>

<p>$$ B(p∧q) = B(p) \times B(q) $$</p>

<h3 id="disjunction">Disjunction</h3>

<p>The disjunction $B(p∨q)$ can be calculated by summing up the second column (where $p$ is true) and the second row (where $q$ is true) but subtracting $B(p∧q)$ (which is summed twice):</p>

<p>$$ B(p∨q) = B(p) + B(q) - B(p∧q) $$</p>

<h2 id="from-boolean-algebra-to-probability">From Boolean algebra to probability</h2>

<p>The probability can be generalised from the similar notations and intuitive allocation picture, by replacing the truth value with the probability value.</p>

<p>Given the following notations:</p>

<ul>
<li>a proposition is denoted as a lowercase letter, e.g. $p$, $q$</li>
<li>the probability of a proposition $p$ is denoted as $ P(p) \in [0, 1] $, where $P(p)$ represents our belief in the truthfulness of the proposition $p$</li>
</ul>

<p>If we enumerate all possible mutually exclusive outcomes and allocate the probability value $1$ to them. We will get similar equations as the Boolean algebra.</p>

<p>$$ P(p) + P(¬p) = 1 $$</p>

<p>The product (chain) rule:</p>

<p>$$ P(p∧q) = P(p) \times P(q|p) $$</p>

<p>Where $P(q|p)$ is called the conditional probability of $q$ given $p$.</p>

<p>And the sum rule:</p>

<p>$$ P(p∨q) = P(p) + P(q) - P(p∧q) $$</p>

<p>Then all the rest of the probability theory could be derived from the definitions above.</p>

<p>Also note that the notations above are equivalent to the Kolmogorov first and second axioms and the probability allocation is the third axiom, only expressed more intuitively but less formally.</p>

                </div>
            </article>
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/article/go-pattern-context-aware-lock/">Go Pattern: Context-aware Lock</a>
                    <span class="line"></span>
                </h1>
                <span class="time">30 November 2020</span>
                <div class="article-body hyphenate">
                    <p>We often use <code>Mutex</code> or <code>RWMutex</code> as locks in Go, but sometimes we need a lock that can be cancelled by a context during the lock attempt.</p>

<p>The pattern is simple - we use a channel with length 1:</p>

<pre><code class="language-go">lockChan := make(chan struct{}, 1)
lockChan &lt;- struct{}{} // lock
&lt;- lockChan            // unlock
</code></pre>

<p>When multiple goroutines try to obtain the lock, only one of them is able to fill into the only slot, and the rest are blocked until the slot is empty again after a readout.</p>

<p>Unlike mutexes, we could easily cancel the lock attempt with a context:</p>

<pre><code class="language-go">select {
    case &lt;-ctx.Done():
        // cancelled
    case lockChan &lt;- struct{}{}:
        // locked
}
</code></pre>

<p>Let&rsquo;s wrap it up:</p>

<pre><code class="language-go">type CtxMutex struct {
    ch chan struct{}
}

func (mu *CtxMutex) Lock(ctx context.Context) bool {
    select {
        case &lt;-ctx.Done():
            return false
        case mu.ch &lt;- struct{}{}:
            return true
    }
}

func (mu *CtxMutex) Unlock() {
    &lt;- mu.ch
}


func (mu *CtxMutex) Locked() bool {
    return len(mu.ch) &gt; 0 // locked or not
}
</code></pre>

<p>Further, <code>context.WithTimeout</code> could be used to apply a timeout to the lock.</p>

                </div>
            </article>
        
            <article class="frontpage">
                <h1>
                    <a href="http://h12.io/article/go-pattern-buffered-writer/">Go Pattern: Buffered Writer</a>
                    <span class="line"></span>
                </h1>
                <span class="time">22 November 2020</span>
                <div class="article-body hyphenate">
                    

<p>A buffered writer is so ubiquitous that we do not usually consider it as a pattern, but sometimes we reinvent it or even do it in an inferior way. Let us look at a real use case first.</p>

<h2 id="batch-processor">Batch processor</h2>

<p>What would you do to improve the throughput of a service? The answer is short: batching.</p>

<p>By processing and sending in a batch of multiple items instead of a single item at a time, you are amortizing the network overhead from the request-response round trip among all the items in the batch.</p>

<p>Then how would you design a client interface to do that batching?</p>

<p>How about this?</p>

<pre><code class="language-go">type BatchProcessor interface {
    Process(items []Item) error
}
</code></pre>

<p>It looks like a straightforward solution, but in reality, it introduces unnecessary complexity in both business logic and error handling.</p>

<p>The processing is often composed of multiple steps working on the items, e.g. transformations and encoding.</p>

<pre><code>items -&gt; transformations -&gt; encoding -&gt; bytes
</code></pre>

<p>With a batch processor interface like above, each step has to loop around the items, and each step has to deal with the errors from multiple items. Not only there is more complexity but also less flexibility. What if the client would like to send the rest of the items, even if some of the items return errors? What if the client instead would like to discard the whole batch if any one of them is erroneous?</p>

<p>There must be a better way.</p>

<h2 id="end-to-end-principle">End-to-end principle</h2>

<p>&ldquo;Smart terminals, dumb network&rdquo;. The <a href="https://en.wikipedia.org/wiki/End-to-end_principle">end-to-end (e2e) principle</a>, articulated in the field of computer network, basically says any smart features should reside in the communicating end nodes, rather than in intermediary nodes.</p>

<p>In our use case, the smart feature is batching. By e2e, we make sure each step should only process a single item, and only the initial sender and the final receiver knows about the batching.</p>

<p>There are various examples In Go&rsquo;s standard packages that already do this, e.g. <a href="https://golang.org/pkg/bufio/#Writer">bufio.Writer</a>. The basic idea is an interface similar to below:</p>

<pre><code class="language-go">type BufferedWriter interface {
    Write(item Item) error
    Flush() error
}
</code></pre>

<p>The caller issues multiple writes to make a batch and a flush to mark the end of the batch. The writer chains the transformation and encoding steps of an item in a single write method and returns the error for the item. When the flush method is called, the writer flushes the whole batch and completes the batch.</p>

<h2 id="stateless-vs-stateful">Stateless vs Stateful</h2>

<p>On the surface, <code>BatchProcessor</code> is stateless while <code>BufferedWriter</code> is stateful, but the former only pushes to its caller the responsibility of aggregating a batch, which is a stateful operation. On the other hand, the final step of the processing - the underlying driver regardless it is of file or network IO - is stateful too. So <code>BufferedWriter</code> does not add additional burden to its caller for managing a stateful interface.</p>

<p>Rather, <code>BufferedWriter</code> not only simplifies the chain of processing within it, but also simplifies the batching logic on its caller side.</p>

<h2 id="concurrency">Concurrency</h2>

<p>A <code>BufferedWriter</code> can become concurrently safe by locking both <code>Write</code> and <code>Flush</code> methods. However, the ideal way of calling a <code>BufferedWriter</code> is from a single goroutine so that the caller is able to control exactly what are in the batch, and we can get rid of the overhead of the lock.</p>

<p>If multiple goroutines must share a single underlying writer and at the same time want to control its own batches, then we could return an object instead of flushing, as below:</p>

<pre><code class="language-go">type Builder interface {
    Write(item Item) error
    Bytes() []byte // return bytes
    Object() Batch // or a batch object
}
</code></pre>

<p>In fact, it becomes the <a href="https://en.wikipedia.org/wiki/Builder_pattern"><em>Builder Pattern</em></a>. Each goroutine has its own builder, building its own batches, and then sending those batches to a shared driver.</p>

<p>In addition, we could even have various write methods, each for its own item type.</p>

<h2 id="transaction">Transaction</h2>

<p>If the caller needs to discard a batch, we could extend it with a rollback method, similar to <a href="https://golang.org/pkg/database/sql/#Tx">sql.Tx</a>:</p>

<pre><code class="language-go">type TxWriter interface {
    Write(item Item) error
    Commit() error
    Rollback() error
}
</code></pre>

<p>Then it becomes the <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html"><em>Unit of Work Pattern</em></a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Whenever we want to process and send multiple items, consider this Buffered Writer Pattern and its variants and see if it can better suit our needs.</p>

                </div>
            </article>
        
        <nav class="pagination">
            <span>- 1 -</span>
            <ul>
                <li>
            
                    <span class="disabled">« Prev</span>
            
                </li>
                <li>
            
                    <a href="/page/2">Next »</a>
            
                </li>
            </ul>
        </nav>
        </main>
        <footer id="site-footer">
            <hr>
            <p>&copy; 2012-22 <span class="my-name">Hǎi-Liàng "Hal" Wáng</span>.<br>
            The content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>, and code is licensed under a <a rel="license" href="/bsd">BSD license</a>.
            </p>
        </footer>

    </body>
</html>
